<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quinela Liga MX</title>
    
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #E8F5E9;
            background-image: url('https://www.toptal.com/designers/subtlepatterns/uploads/soccer.png');
            background-repeat: repeat;
            margin: 0;
            padding: 20px;
        }
        .container {
            max-width: 600px; margin: 40px auto; background-color: #ffffff;
            border-radius: 12px; box-shadow: 0 8px 25px rgba(0, 0, 0, 0.1);
            overflow: hidden; color: #333;
        }
        .form-header {
            background-color: #002060; padding: 20px 15px;
        }
        .form-header h1 {
            color: #ffffff; text-align: center; font-size: 26px; margin: 0;
            text-transform: uppercase; letter-spacing: 1px; display: flex;
            align-items: center; justify-content: center; gap: 20px;
        }
        .titulo-seccion {
            color: #002060; font-size: 18px; font-weight: bold;
            text-align: center; margin-bottom: 15px;
        }
        .header-icon { width: 35px; height: auto; }
        .form-content { padding: 30px; }
        form { display: flex; flex-direction: column; gap: 25px; }
        label { font-weight: bold; color: #002060; }
        input[type="text"], input[type="number"], select {
            width: 100%; padding: 12px; font-size: 16px; border: 2px solid #ccc;
            border-radius: 8px; box-sizing: border-box; transition: all 0.3s;
        }
        input:focus, select:focus {
            border-color: #0070C0; box-shadow: 0 0 8px rgba(0, 112, 192, 0.2); outline: none;
        }
        button[type="submit"] {
            background-color: #00B050; color: white; cursor: pointer; padding: 15px;
            font-size: 18px; font-weight: bold; border: none; border-radius: 8px;
            margin-top: 10px; transition: all 0.3s;
        }
        button[type="submit"]:hover { background-color: #009040; transform: translateY(-2px); }
        .instrucciones-box {
            padding: 20px;
            margin-bottom: 25px;
            border-radius: 8px;
            background: linear-gradient(135deg, #E8F5E9, #C8E6C9);
            color: #1B5E20;
            border-left: 5px solid #0070C0;
            max-height: 250px;
            overflow-y: auto;
        }
        .info-quiniela { margin-bottom: 10px; font-weight: bold; text-align: center; }
        .titulo-jornada {
            text-align: center; color: #002060; margin-top: 0; margin-bottom: 25px;
        }
        .partido {
            display: flex; align-items: center; justify-content: space-between; gap: 10px;
        }
        .partido label { flex: 1; text-align: center; }
        .partido input { width: 60px; text-align: center; }
        #mensaje-respuesta {
            margin-top: 20px; padding: 15px; border-radius: 8px; font-weight: bold;
            text-align: center; border: 2px solid transparent; transition: all 0.3s;
        }
        .mensaje-exito {
            background-color: #d4edda; color: #155724; border-color: #c3e6cb;
        }
        .mensaje-error {
            background-color: #f8d7da; color: #721c24; border-color: #f5c6cb;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="form-header">
            <h1>
                <img src="https://upload.wikimedia.org/wikipedia/commons/d/d3/Soccerball.svg" class="header-icon" alt="Balón de fútbol">
                <span>Quinela Liga MX</span>
                <img src="https://upload.wikimedia.org/wikipedia/commons/d/d3/Soccerball.svg" class="header-icon" alt="Balón de fútbol">
            </h1>
        </div>
        <div class="form-content">
            <h2 class="titulo-seccion">Instrucciones y Reglas</h2>
            <div id="instrucciones" class="instrucciones-box">Cargando reglas...</div>
            
            <div class="info-quiniela">
                <span>Participantes: <span id="participantes">...</span></span>   
            <div
            <div
                <span>Fecha Límite: <span id="fechaLimite">...</span></span>
            </div>

            <form id="formulario">
                <label for="nombre">Tu Nombre:</label>
                <input type="text" id="nombre" name="nombre" placeholder="Escribe tu nombre o apodo" required>
                <label for="codigo">Código de Acceso:</label>
                <input type="text" id="codigo" name="codigo" placeholder="El código que se te asignó" required>
                
                <h2 id="titulo-jornada" class="titulo-jornada">Cargando Jornada...</h2>

                <div id="partidos">Cargando partidos...</div>
                <label for="comodin">Partido Comodin(Puntos doble del comodin selecionado) :</label>
                <select id="comodin" name="comodin" required>
                    <option value="">Primero carga los partidos</option>
                </select>
                <label for="totalgoles">Total de goles:</label>
                <input type="number" id="totalgoles" name="totalgoles" min="0" placeholder="Ej: 25 (3 pts extra si le atinas al total de goles real)" required>
                <button type="submit">Enviar Quinela</button>
            </form>
            
            <div id="mensaje-respuesta" style="display: none;"></div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const scriptURL = "https://script.google.com/macros/s/AKfycbwSc2WDuBgI7rZ2G8R63uSD_j3G2y9Hx-QwLAZJRbpQ-_EtkTR9E_FYw-PXelt_z3UD/exec";
            let fechaLimiteISO = null;

            const form = document.getElementById("formulario");
            const mensajeDiv = document.getElementById('mensaje-respuesta');

            async function cargarDatos() {
                try {
                    const res = await fetch(scriptURL);
                    if (!res.ok) throw new Error(`Error de red: ${res.statusText}`);
                    const data = await res.json();
                    
                    document.getElementById("titulo-jornada").textContent = `JORNADA ${data.numero_jornada}`;
                    
                    let textoOriginal = data.reglas;
                    let textoFormateado = textoOriginal.replace(/\*(.*?)\*/g, '<strong>$1</strong>');
                    textoFormateado = textoFormateado.replace(/_(.*?)_/g, '<u>$1</u>');
                    textoFormateado = textoFormateado.replace(/\n/g, '<br>');

                    document.getElementById("instrucciones").innerHTML = `<strong>Reglas:</strong><br>${textoFormateado}`;
                    document.getElementById("participantes").textContent = data.participantes;
                    document.getElementById("fechaLimite").textContent = new Date(data.fecha_limite).toLocaleString('es-MX', { dateStyle: 'long', timeStyle: 'short' });
                    fechaLimiteISO = data.fecha_limite;

                    const partidosDiv = document.getElementById("partidos");
                    const comodinSelect = document.getElementById("comodin");
                    partidosDiv.innerHTML = ''; 
                    comodinSelect.innerHTML = '<option value=""> Selecciona partido comodin </option>';
                    data.partidos.forEach((p, i) => {
                        const partido = document.createElement("div");
                        partido.className = "partido";
                        partido.innerHTML = `
                            <label>${p.local}</label>
                            <input type="number" name="gol_local_${i}" min="0" required>
                            <span>vs</span>
                            <input type="number" name="gol_visitante_${i}" min="0" required>
                            <label>${p.visitante}</label>`;
                        partidosDiv.appendChild(partido);
                        const option = document.createElement("option");
                        option.value = i;
                        option.textContent = `${p.local} vs ${p.visitante}`;
                        comodinSelect.appendChild(option);
                    });
                } catch (err) {
                    mensajeDiv.textContent = "Error al Cargar Datos. Revisa la conexión e intenta recargar la página.";
                    mensajeDiv.className = 'mensaje-error';
                    mensajeDiv.style.display = 'block';
                    console.error("Error detallado:", err);
                }
            }

            form.addEventListener("submit", async function (e) {
                e.preventDefault();
                const submitButton = form.querySelector('button[type="submit"]');
                submitButton.disabled = true;
                submitButton.textContent = 'Enviando...';
                mensajeDiv.style.display = 'none';

                if (fechaLimiteISO && new Date() > new Date(fechaLimiteISO)) {
                    mensajeDiv.textContent = "La fecha límite ha sido superada. Ya no puedes enviar la quinela.";
                    mensajeDiv.className = 'mensaje-error';
                    mensajeDiv.style.display = 'block';
                    submitButton.disabled = false;
                    submitButton.textContent = 'Enviar Quinela';
                    return;
                }

                try {
                    const res = await fetch(scriptURL, { method: "POST", body: new FormData(form) });
                    const result = await res.json();
                    
                    mensajeDiv.textContent = result.mensaje;
                    if (result.mensaje.includes("éxito")) {
                        mensajeDiv.className = 'mensaje-exito';
                        form.reset();
                    } else {
                        mensajeDiv.className = 'mensaje-error';
                    }
                    mensajeDiv.style.display = 'block';

                } catch (err) {
                    mensajeDiv.textContent = "Hubo un problema al enviar la quinela. Inténtalo de nuevo.";
                    mensajeDiv.className = 'mensaje-error';
                    mensajeDiv.style.display = 'block';
                    console.error(err);
                } finally {
                    submitButton.disabled = false;
                    submitButton.textContent = 'Enviar Quinela';
                }
            });

            cargarDatos();
        });
    </script>
</body>
</html>
